---
title: "Normalization and Standardization"
author: "Joel Parker"
date: "2023-07-17"
output: html_document
---

```{r setup, include=FALSE}
# Set global chunk obptions
knitr::opts_chunk$set(fig.width=12, fig.height=12)

# Data 
library(tidyverse)
library(openxlsx)
library(kableExtra)
library(table1)
library(flextable)
library(reshape2)


# Heat Map
library(pheatmap)
library(RColorBrewer)
library(rstatix)
library(plotly)

# PCA
library(factoextra)
library(FactoMineR)


## Combining plots
library(ggpubr)


## Image package
library(magick)

## Pairwise comparisons
library(emmeans)

# Metabolomics Pipeline source files
files.sources = list.files("../R")
sapply(paste0("../R/",files.sources), source)

```


## Normalization and Standardization
In its raw form, the peak data contain counts for each metabolite in each sample.
Standardization and normalization are important steps to improve the 
signal-to-noise ratio. In the next section, we are implementing the same 
standardization and normalization methods used by Metabolon. First we will load
the raw peak data into R. To start we:

1. Provide a path with the file name to the Data tables .xlsx file provided by
Metabolon. You may need to change this file path to reflect the name of the data
tables .xlsx file for your project. 

2. Read in the "Peak Area Data" tab from the .xlsx file provided above.


```{r load Raw peak data}
# Provide a path to Metabolon .xlsx file. 
metabolon_path <- "../Data/Metabolon/UNAZ-0501-22VW_ DATA TABLES.xlsx"


# 2. Load raw peak data
peak_data <- read.xlsx(metabolon_path, sheet = "Peak Area Data")
```

### Median Standardization
The first step in the Metabolon normalization process is median standardization. 
This step will ensure that each metabolite in the dataset has the same median 
value. To show this we will show the box plots for 5 metabolites before and after
median normalization. Below is the box plots before median standardization where 
we:

1. Select the first five metabolites for the box plot. 

2. Create the boxplot data

3. Plot the box plots for each of the five metabolites. 

```{r before median standardization}
# 1. Select the first five metabolites for the box plot. 
metabolites <- names(peak_data)[2:6]


# 2. Create the boxplot data
plot_data <- peak_data %>%
  reshape2::melt(id.vars="PARENT_SAMPLE_NAME") %>%
  filter(variable %in% metabolites)


# 3. Plot the box plots for each of the five metabolites. 
ggplot(plot_data,aes(x=variable,y=value)) +
  geom_boxplot() +
  theme_bw()
```
Now we perform median standardization by:

1. Initializing a new peak_data_norm matrix

2. Create a data set containing the median value for each metabolite

3. Divide each value by the median metabolite value. 

```{r median standardization}
# 1. Initialize a new peak_data_med matrix
peak_data_norm <-  peak_data 


# 2. Create a matrix containing the median value for each metabolite 
peak_data_med <- peak_data_norm %>%
  select(-PARENT_SAMPLE_NAME) %>%
  summarise_all(median, na.rm = T)


# 3. Divide each value for each metabolite by the median value of that metabolite
for(i in colnames(peak_data_med)){
  peak_data_norm[,i] <- peak_data_norm[,i]/peak_data_med[,i]
}

```

Now we can look at those same metabolites from before. We will notice that the 
median value for all metabolites are now lined up at 1. 

```{r after median standardization}
# 1. Select the first five metabolites for the box plot. 
metabolites <- names(peak_data)[2:6]


# 2. Create the boxplot data
plot_data <- peak_data_norm %>%
  reshape2::melt(id.vars="PARENT_SAMPLE_NAME") %>%
  filter(variable %in% metabolites)


# 3. Plot the box plots for each of the five metabolites. 
ggplot(plot_data,aes(x=variable,y=value)) +
  geom_boxplot() +
  theme_bw()
```


### Minimum value imputation
Once we standardize each metabolite by the median value,
we impute the missing values for each metabolite with the minimum value for that
metabolite. We do this in the following steps.

1. Initialize the new peak_data_imputed matrix

2. Find the minimum value for each metabolite.

3. Create a for loop such that if a metabolite has a missing observation, then
 the minimum value for that metabolite is imputed. 


```{r replace missing observations}
# 1. Initialize the new peak_data_imputed matrix
peak_data_imputed <- peak_data_norm


# 2. Find the minimum value for each metabolite and compute 1/5 of that value
peak_data_mins <- peak_data_imputed %>%
  select(-PARENT_SAMPLE_NAME) %>%
  summarise_all(min, na.rm = T) 


# 3. Impute the value
for(i in colnames(peak_data_mins)){
  if(length(peak_data_imputed[,i][is.na(peak_data_imputed[,i])]) > 0){
    peak_data_imputed[which(is.na(peak_data_imputed[,i])),i] <- as.numeric(peak_data_mins[i])
  }
}
```


### Log Transformation
The final step is to take a natural log transformation of each of the values.   


1. Log transform all of the values

```{r log19 Normalization}
# 1. Log transform all of the values
peak_data_log <- peak_data_imputed %>%
  mutate_if(is.numeric, log)
```



### Save data
Now that we have imputed and normalized our data, we need to save the data for 
subsequent sections. We will save peak_data_log in the "Data/Processed" Folder 
under the file name "Log_transformed_data.csv".

```{r save-data 1}
# 1. Save log transformed data.
write.csv(peak_data_log, file = "../Data/Processed/Log_transformed_data.csv",
          row.names = F)
```


